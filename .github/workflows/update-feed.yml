name: Update Feed

on:
  schedule:
    - cron: '0 */12 * * *'  # Every 12 hours (0:00 and 12:00 UTC)
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required to push commits

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch feed from URLScans
        env:
          FEED_BASE_URL: ${{ secrets.FEED_BASE_URL || 'https://urlscans.com' }}
          FEED_SECRET: ${{ secrets.FEED_EXPORT_SECRET }}
        run: |
          if [ -n "$FEED_SECRET" ]; then
            curl -sS -H "x-feed-secret: $FEED_SECRET" "${FEED_BASE_URL}/api/feed/export?days=30" -o feed.txt
          else
            curl -sS "${FEED_BASE_URL}/api/feed/export?days=30" -o feed.txt
          fi
          echo "Lines: $(wc -l < feed.txt)"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add feed.txt
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "chore: update feed $(date -u +%Y-%m-%dT%H:%MZ)"
            git push
          fi
